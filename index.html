<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<title>Space Invaders</title>
<style>
  body {
    margin: 0;
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  canvas {
    background: #000;
    display: block;
    margin: 40px auto 0;
    border: 2px solid #fff;
    touch-action: none; /* evita lo scrolling su mobile */
  }
  #score {
    font-size: 24px;
    margin-bottom: 20px;
  }
  #overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #fff;
    background: rgba(0, 0, 0, 0.7);
    visibility: hidden;
  }
  #overlay.show {
    visibility: visible;
  }
  button {
    padding: 10px 20px;
    background: #fff;
    color: #000;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
    margin-top: 10px;
  }
</style>
</head>
<body>
<canvas id="game" width="480" height="640"
        style="width:100%;max-width:480px;height:auto;box-sizing:border-box;"></canvas>
  <div id="overlay">
    <h1 id="message">Game Over</h1>
    <button id="restart">Restart</button>
  </div>
  <div id="score">Score: 0</div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const overlay = document.getElementById("overlay");
    const messageEl = document.getElementById("message");
    const restartBtn = document.getElementById("restart");

    const cw = canvas.width,
      ch = canvas.height;

    /* =====================
       Utility helpers
    =====================*/
    const clamp = (value, min, max) => Math.max(min, Math.min(max, value));

    function setPlayerByClientX(clientX) {
      const rect = canvas.getBoundingClientRect();
      const canvasX = clientX - rect.left;
      player.x = clamp(canvasX - player.w / 2, 0, cw - player.w);
    }

    /* =====================
       Entity classes
    =====================*/
    class Player {
      constructor() {
        this.w = 40;
        this.h = 20;
        this.x = (cw - this.w) / 2;
        this.y = ch - this.h - 10;
        this.speed = 5;
        this.cooldown = 0;
      }
      move(dir) {
        this.x += dir * this.speed;
        this.x = clamp(this.x, 0, cw - this.w);
      }
      shoot(bullets) {
        if (this.cooldown <= 0) {
          bullets.push(new Bullet(this.x + this.w / 2, this.y, -7, "player"));
          this.cooldown = 15;
        }
      }
      update() {
        if (this.cooldown > 0) this.cooldown--;
      }
      draw() {
        ctx.fillStyle = "#0f0";
        ctx.fillRect(this.x, this.y, this.w, this.h);
      }
    }

    class Bullet {
      constructor(x, y, dy, type) {
        this.x = x;
        this.y = y;
        this.dy = dy;
        this.r = 3;
        this.type = type;
      }
      update() {
        this.y += this.dy;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fillStyle = this.type === "player" ? "#fff" : "#f00";
        ctx.fill();
      }
      offScreen() {
        return this.y < 0 || this.y > ch;
      }
    }

    class Invader {
      constructor(x, y) {
        this.w = 30;
        this.h = 20;
        this.x = x;
        this.y = y;
      }
      draw() {
        ctx.fillStyle = "#0ff";
        ctx.fillRect(this.x, this.y, this.w, this.h);
      }
    }

    /* =====================
       Game state vars
    =====================*/
    let player, bullets, invaders, dir, frames, gameOver, score;

    /* =====================
       Core game functions
    =====================*/
    function init() {
      player = new Player();
      bullets = [];
      invaders = [];
      dir = 1; // 1 right, -1 left
      frames = 0;
      gameOver = false;
      score = 0;
      scoreEl.textContent = "Score: 0";
      overlay.classList.remove("show");

      const rows = 5,
        cols = 10,
        spacingX = 40,
        spacingY = 40,
        startX = 30,
        startY = 60;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          invaders.push(new Invader(startX + c * spacingX, startY + r * spacingY));
        }
      }
    }

    function rectCircleCollide(rect, circ) {
      let distX = Math.abs(circ.x - (rect.x + rect.w / 2));
      let distY = Math.abs(circ.y - (rect.y + rect.h / 2));
      if (distX > rect.w / 2 + circ.r) return false;
      if (distY > rect.h / 2 + circ.r) return false;
      if (distX <= rect.w / 2) return true;
      if (distY <= rect.h / 2) return true;
      let dx = distX - rect.w / 2;
      let dy = distY - rect.h / 2;
      return dx * dx + dy * dy <= circ.r * circ.r;
    }

    function circleRectCollide(circ, rect) {
      return (
        circ.x > rect.x &&
        circ.x < rect.x + rect.w &&
        circ.y > rect.y &&
        circ.y < rect.y + rect.h
      );
    }

    function update() {
      if (gameOver) return;
      frames++;

      // Player movement via keyboard
      if (keys["ArrowLeft"]) player.move(-1);
      if (keys["ArrowRight"]) player.move(1);
      if (keys[" "] || keys["Space"]) player.shoot(bullets);
      player.update();

      // Invader movement
      if (frames % 30 === 0) {
        let step = 10 * dir;
        let changeRow = false;
        for (let inv of invaders) {
          inv.x += step;
          if (inv.x <= 0 || inv.x + inv.w >= cw) changeRow = true;
        }
        if (changeRow) {
          dir *= -1;
          for (let inv of invaders) {
            inv.y += 20;
            if (inv.y + inv.h >= player.y) {
              endGame("Game Over");
            }
          }
        }
        // Random invader bullet
        if (invaders.length && Math.random() < 0.3) {
          const shooter = invaders[Math.floor(Math.random() * invaders.length)];
          bullets.push(new Bullet(shooter.x + shooter.w / 2, shooter.y + shooter.h, 4, "invader"));
        }
      }

      // Update bullets
      bullets.forEach((b) => b.update());
      bullets = bullets.filter((b) => !b.offScreen());

      // Bullet collisions
      bullets.forEach((b, i) => {
        if (b.type === "player") {
          invaders.forEach((inv, j) => {
            if (rectCircleCollide(inv, b)) {
              invaders.splice(j, 1);
              bullets.splice(i, 1);
              score += 10;
              scoreEl.textContent = "Score: " + score;
            }
          });
        } else {
          if (circleRectCollide(b, player)) {
            endGame("You were hit!");
          }
        }
      });

      // Win condition
      if (invaders.length === 0) {
        endGame("You Win!");
      }
    }

    function draw() {
      ctx.clearRect(0, 0, cw, ch);
      player.draw();
      invaders.forEach((inv) => inv.draw());
      bullets.forEach((b) => b.draw());
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    function endGame(msg) {
      gameOver = true;
      messageEl.textContent = `${msg} Score: ${score}`;
      overlay.classList.add("show");
    }

    /* =====================
       Input handling
    =====================*/
    const keys = {};
    window.addEventListener("keydown", (e) => {
      keys[e.key] = true;
    });
    window.addEventListener("keyup", (e) => {
      keys[e.key] = false;
    });

    // Mouse controls
    canvas.addEventListener("mousemove", (e) => {
      setPlayerByClientX(e.clientX);
    });
    canvas.addEventListener("mousedown", () => {
      player.shoot(bullets);
    });

    // Touch controls
    canvas.addEventListener(
      "touchmove",
      (e) => {
        e.preventDefault(); // evita lo scroll
        setPlayerByClientX(e.touches[0].clientX);
      },
      { passive: false }
    );
    canvas.addEventListener(
      "touchstart",
      (e) => {
        e.preventDefault();
        player.shoot(bullets);
      },
      { passive: false }
    );

    // Restart button
    restartBtn.addEventListener("click", () => {
      init();
    });

    // Start game
    init();
    loop();
  </script>
</body>
</html>
